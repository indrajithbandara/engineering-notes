Синтез русской речи в Linux

03/12/2008 22:41:07
Лежать... Сидеть... Голос!

В фантастических фильмах или книгах немыслимо представить себе компьютерную систему управления без голосового сопровождения. Мягкий, с эротическими нотками, ласкающий слух, женский голос компьютерной системы обычно уверенным тоном заявляет, что до уничтожения всего мира осталось где-то около 2,128 секунды. И я подумал, что не плохо было бы иметь что-то подобное и у себя дома. "Умный Дом" безусловно должен разговаривать. Пусть без эротики, но желательно по-русски.

Выяснилось, что в природе существует некий проект Festival, которым занимается сразу несколько институтов и множество специалистов, профессоров и студентов. Вокруг этой системы существует также много всевозможных программ, утилит, языков, моделей и прочего... Но меня, прежде всего, интересовал русский. Слава Богу нашелся добрый человек, который создал русский голос для системы синтеза речи Festival. Вот ссылка на его страничку, касательно этой области

http://festlang.berlios.de/docu/doku.php?id=russianru

Благодаря автору, наработкам МГУ, а также словарям ударений и голосу Карлова, у меня появилась возможность подарить системе управления домом возможность говорить. Наверное, девушка с ласково-зазывающим голосом была бы лучше, но, поверьте, имеющийся мужской голос тоже неплох.

Вскоре, правда, выяснилось, что на материнской плате сервера, который был собран из практически антикварного компьютера, не оказалось интегрированной звуковой платы. Но к счастью оказался свободный PCI-слот, куда была установлена самая дешевая PCI-плата на базе C-Media 8738. Linux без проблем распознал эту звуковую карту без каких-либо дополнительных манипуляций.

Согласно инструкции необходимо скачать, собственно, сам голос, speechtools и festival версии 1.96. Скачиваем, компилируем. Стоит отметить, что для Debian и некоторых других дистрибутивов есть уже готовые пакеты (в стабильных или нестабильных ветках). Но если есть желание скомпилировать festival под Debian lenny самостоятельно, то, во-первых, следует скачать самую свежую версию. (Требуется установленный пакет subversion)

svn checkout http://svn.berlios.de/svnroot/repos/festlang/trunk/speech_tools
svn checkout http://svn.berlios.de/svnroot/repos/festlang/trunk/festival

А, во-вторых, при компиляции следует ждать следующих ошибок:
EST_TNamedEnum.cc:215: error: no matching function for call to "split"
Это связано с тем, что в Debian lenny используется компилятор gcc 4.3.2, который имеет ошибку, мешающую успешной компиляции программы festival.
Решение простое. В файл config/compilers/gcc_defaults.mak в строку CXXFLAGS нужно добавить опцию -ffriend-injection

Распаковываем архив с русским голосом в папку festival/lib/voices/russian/msu_ru_nsh_clunits. Теперь переходим в папку festival/bin и запускаем программу синтеза

./festival (voice_msu_ru_nsh_clunits) (SayText "Привет, дружище!") (quit)

Важно! Русский текст должен быть в кодировке UTF8!

Если Вы компилировали festival самостоятельно из SVN, то распаковывать голос нужно в папку festival/share/voices/russian/
При этом важно отредактировать файл festival/share/voices/russian/msu_ru_nsh_clunits/festvox/msu_ru_nsh_clunits.scm
В этом файле перед строчкой

(provide 'msu_ru_nsh_clunits)

нужно добавить

(proclaim_voice
 'msu_ru_nsh_clunits
 '((language russian)
   (gender male)
   (dialect moscow)
   (coding utf-8)
   (description
    "Russian festival voice.")))

Если все было сделано правильно, то мы услышим роботоподобный, но вполне внятный голос нашей системы. Стоит сказать, что для генерации голоса нужен, конечно, компьютер помощнее. На моем сервере длинные фразы формируются несколько секунд.

В случае появления ошибки:
Linux: can't open /dev/dsp
нужно установить пакеты: alsa-oss и oss-compat

Теперь у меня появилась необходимость привязать festival с русским голосом к системе автоматизации дома. Программа festival может работать в пакетном режиме или в качестве TCP-сервера. В пакетном режиме можно запускать ее из командной строки или по cron'у

festival -b my_text.txt

Где в файле my_text.txt прописывать какой-либо текст, но оптимальнее, правильнее запустить программу в качестве сервера

festival --server &

Тогда появляется возможность обратиться к серверу синтеза речи на 1314 порт. Как это работает можно проверить telnet'ом

telnet localhost 1314

Можно задать вышеуказанные команды и festival выполнит их. Удобно, не правда ли? Неудобно каждый раз задавать голос. Чтобы прописать голос по умолчанию, нужно отредактировать файл lib/init.scm
Голос должен быть прописан так

;;; Default voice (have to do something cute so autoloads still work)
(eval (list voice_msu_ru_nsh_clunits))

Теперь мы можем сразу давать команду (SayText ""). А имея запущенный TCP-сервер, у нас также появляется возможность посылать команды нашей "птице-говоруну" не только непосредственно из командного режима, но и с помощью, например, PHP-скриптов. Если с командной строкой все более-менее понятно, то PHP-скрипт может выглядеть примерно так:

<?
    $host="localhost";
    $my_text="Температура воздуха на улице 5 градусов";
    $h=fsockopen($host,1314);
    fwrite($h,"(SayText \"$my_text\")\n");
    sleep(3);
    fwrite($h,"(quit)");
    fclose($h);
?>

В случае, когда мы посылаем команды серверу с другого комьютера, можно наблюдать следующую надпись:

rejected from srv2.home not in access list

Для решения этой проблемы нужно отредактировать файл lib/festivsal.scm - найти в нем опцию defvar server_access_list и добавить необходимый нам узел или IP-адрес.

 Моя компьютерная система каждый час сообщает об основных параметрах работы, температуре воздуха. Обязательно система сообщает о различных аварийных ситуациях. Например, говорит, что неплохо было бы вымыть посуду или делает замечание, если люди слишком сильно шумят после 11 часов вечера. ;)

Несколько слов о непосредственном подключении сервера и колонок. Тянуть отдельный кабель мне показалось нерациональным, поэтому я пустил звук по витой паре. В 100Мб/с сети для передачи данных используется только 4 провода из 8. Кабель у меня идет один, на нем сеть, звук и 1-wire шина. Качество звука значения особого не имеет. В качестве колонок использовались старые ненужные активные компьютерные колонки. Для голоса более чем достаточно. Кстати, мой сервер генерирует не только речь. Настроены также некоторые звуковые события. Например, утром играет гимн Советского... ну то есть Российской Федерации.

Сейчас глас системы установлен только в одном помещении, однако в будущем ничего не мешает вывести звук на 6 разных направлений (колонок). Ведь каналов у звуковой карты 6, значит программно переключая конкретный канал, можно адресовать сообщения в определенное место. Это в планах.

Интеграция системы с GSM-сигнализацией позволило мне использовать синтез речи в случае проникновения в дом. На этот случай у меня подготовлен соответствующий файлик с литературно-художественными фразами повышенной смысловой емкости, почти поэзией. Но, надеюсь, синтезировать текст этого файлика программе festival не потребуется.
